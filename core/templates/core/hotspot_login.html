<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Hotspot</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .plan-card:hover {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-5px);
        }
        .plan-card.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loader {
            border-top-color: #fff;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg mx-4">
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Welcome!</h1>
            <p class="text-gray-600 mb-6">Choose a plan to get connected.</p>
        </div>

        <!-- Hidden form for CSRF token and data handling -->
        <form id="payment-form" class="space-y-6">
            <div id="plans-container" class="space-y-4">
                {% for plan in plans %}
                <div class="plan-card p-5 border-2 border-gray-200 rounded-xl cursor-pointer transition-all duration-200 ease-in-out" data-plan-id="{{ plan.id }}">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">{{ plan.name }}</h3>
                            <p class="text-sm text-gray-500">{{ plan.duration_minutes }} minutes</p>
                        </div>
                        <span class="font-bold text-2xl text-blue-600">UGX {{ plan.price }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div>
                <label for="phone-number" class="block text-sm font-medium text-gray-700">Phone Number (MTN MoMo)</label>
                <input type="tel" id="phone-number" name="phone-number" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="e.g., 256771234567" required>
            </div>
            
            <button type="submit" id="pay-button" class="w-full flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 ease-in-out">
                <span id="button-text">Pay Now</span>
                <div id="button-spinner" class="hidden h-5 w-5 border-4 border-gray-300 rounded-full loader"></div>
            </button>
        </form>

        <div id="message" class="mt-4 p-4 text-green-700 bg-green-100 rounded-lg hidden" role="alert"></div>
        <div id="error" class="mt-4 p-4 text-red-700 bg-red-100 rounded-lg hidden" role="alert"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const plansContainer = document.getElementById('plans-container');
            const planCards = document.querySelectorAll('.plan-card');
            const phoneInput = document.getElementById('phone-number');
            const paymentForm = document.getElementById('payment-form');
            const payButton = document.getElementById('pay-button');
            const buttonText = document.getElementById('button-text');
            const buttonSpinner = document.getElementById('button-spinner');
            const messageDiv = document.getElementById('message');
            const errorDiv = document.getElementById('error');

            let selectedPlanId = null;

            // Handle plan selection
            plansContainer.addEventListener('click', function(event) {
                const card = event.target.closest('.plan-card');
                if (card) {
                    planCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedPlanId = card.dataset.planId;
                    errorDiv.classList.add('hidden');
                }
            });

            // Handle form submission
            paymentForm.addEventListener('submit', function(event) {
                event.preventDefault();
                messageDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');

                if (!selectedPlanId) {
                    errorDiv.textContent = 'Please select a plan.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const phoneNumber = phoneInput.value.trim();
                if (!phoneNumber) {
                    errorDiv.textContent = 'Please enter your phone number.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                // Show loading state
                payButton.disabled = true;
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');

                // Prepare data payload
                const data = {
                    phone_number: phoneNumber,
                    plan_id: selectedPlanId
                };

                // Fetch options
                const requestOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                };

                // The Django URL is hardcoded here to prevent a server-side template rendering issue.
                fetch('/api/initiate-payment/', requestOptions)
                    .then(response => {
                        return response.json().then(data => {
                            if (!response.ok) {
                                throw new Error(data.error || 'Server error occurred.');
                            }
                            return data;
                        });
                    })
                    .then(data => {
                        messageDiv.textContent = data.message;
                        messageDiv.classList.remove('hidden');
                        console.log('Payment initiated successfully:', data);
                    })
                    .catch(error => {
                        errorDiv.textContent = `An error occurred: ${error.message}. Please try again.`;
                        errorDiv.classList.remove('hidden');
                        console.error('Error:', error);
                    })
                    .finally(() => {
                        // Reset loading state
                        payButton.disabled = false;
                        buttonText.classList.remove('hidden');
                        buttonSpinner.classList.add('hidden');
                    });
            });

            // A helper function to get the CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.startsWith(name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
